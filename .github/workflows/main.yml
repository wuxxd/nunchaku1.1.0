name: Build Nunchaku 1.1.0 for Torch 2.7
on: workflow_dispatch  # 允许手动点击触发

jobs:
  build_wheels:
    name: Build for Windows
    runs-on: windows-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          ref: v1.1.0  # 强制指定检出 1.1.0 版本代码
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # 你的 Python 版本

      - name: Install CUDA 12.4
        uses: jimmy-p/setup-cuda@v2.1.0
        with:
          cuda_version: '12.4.1' 
          # 注意：用 12.4 编译出的轮子可以在你的 12.8 上完美运行
          # 且 Torch Nightly 目前主要基于 12.4 构建

      - name: Install MSVC & Ninja
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install PyTorch Nightly (2.7)
        run: |
          python -m pip install --upgrade pip
          pip install ninja wheel setuptools
          # 安装 Torch Nightly (2.7.0.dev...) 对应的 CUDA 12.4 版本
          pip install --pre torch torchvision torchaudio --index-url https://download.pytorch.org/whl/nightly/cu124

      - name: Build Wheel
        run: |
          # 强制设置编译参数，避免找不到 CUDA
          $env:CUDA_HOME = $env:CUDA_PATH
          $env:FORCE_CUDA = "1"
          $env:TORCH_CUDA_ARCH_LIST = "8.0;8.6;8.9;9.0" 
          # 上面涵盖了 30系(8.6), 40系(8.9), H100(9.0) 显卡
          
          python setup.py bdist_wheel

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nunchaku-1.1.0-win-torch2.7
          path: dist/*.whl
